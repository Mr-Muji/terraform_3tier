name: "í…Œë¼í¼ CI/CD"

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches:
      - main    # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (CD íŠ¸ë¦¬ê±°)
  pull_request:
    branches:
      - main    # main ë¸Œëœì¹˜ë¡œ PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (CI íŠ¸ë¦¬ê±°)

# GitHub ì•¡ì…˜ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read             # ì €ì¥ì†Œ ë‚´ìš©ì„ ì½ì„ ìˆ˜ ìˆëŠ” ê¶Œí•œ
  pull-requests: write       # PRì— ëŒ“ê¸€ì„ ë‚¨ê¸¸ ìˆ˜ ìˆëŠ” ê¶Œí•œ

jobs:
  terraform:
    name: "í…Œë¼í¼ ì‘ì—…"
    runs-on: ubuntu-latest   # Ubuntu ìµœì‹  ë²„ì „ì—ì„œ ì‘ì—… ì‹¤í–‰
    
    # AWS ìê²© ì¦ëª… ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    # ì´ í™˜ê²½ ë³€ìˆ˜ë“¤ì€ í…Œë¼í¼ì´ AWS ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©ë¨
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}           # AWS ì•¡ì„¸ìŠ¤ í‚¤
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}   # AWS ì‹œí¬ë¦¿ í‚¤
      AWS_REGION: "ap-northeast-2"                                  # AWS ë¦¬ì „ (ì„œìš¸)
      TF_VAR_environment: "dev"                                     # í…Œë¼í¼ í™˜ê²½ ë³€ìˆ˜ (ê°œë°œ í™˜ê²½)
    
    steps:
      # ----- CI ë‹¨ê³„ ì‹œì‘ (ì½”ë“œ í’ˆì§ˆ ë° ìœ íš¨ì„± ê²€ì‚¬) -----
      
      # ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3    # GitHub ì•¡ì…˜ ê³µì‹ ì²´í¬ì•„ì›ƒ ì•¡ì…˜ v3 ì‚¬ìš©

      # í…Œë¼í¼ CLI ì„¤ì¹˜
      - name: í…Œë¼í¼ ì„¤ì •
        uses: hashicorp/setup-terraform@v2   # HashiCorp ê³µì‹ í…Œë¼í¼ ì„¤ì • ì•¡ì…˜
        with:
          terraform_version: 1.11.2  # íŠ¹ì • í…Œë¼í¼ ë²„ì „ ì§€ì • (í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­ì— ë§ê²Œ ìˆ˜ì •)

      # í…Œë¼í¼ ì´ˆê¸°í™” - ê³µê¸‰ì ë‹¤ìš´ë¡œë“œ ë° ë°±ì—”ë“œ êµ¬ì„±
      - name: í…Œë¼í¼ ì´ˆê¸°í™”
        id: init
        run: terraform init   # S3 ë°±ì—”ë“œ êµ¬ì„± ë° ëª¨ë“ˆ/ê³µê¸‰ì ì´ˆê¸°í™”

      # í…Œë¼í¼ ì½”ë“œ í¬ë§· ê²€ì‚¬ - ì½”ë“œ ìŠ¤íƒ€ì¼ ì¼ê´€ì„± í™•ì¸
      - name: í…Œë¼í¼ í¬ë§· í™•ì¸
        id: fmt
        run: terraform fmt -check    # í¬ë§· ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ì¢…ë£Œ ì½”ë“œ ë°˜í™˜
        continue-on-error: true      # í¬ë§· ì˜¤ë¥˜ê°€ ìˆì–´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰

      # í…Œë¼í¼ êµ¬ì„± ìœ íš¨ì„± ê²€ì‚¬ - ë¬¸ë²• ë° íƒ€ì… ì˜¤ë¥˜ í™•ì¸
      - name: í…Œë¼í¼ ìœ íš¨ì„± ê²€ì‚¬
        id: validate
        run: terraform validate -no-color   # ìœ íš¨ì„± ê²€ì‚¬ ìˆ˜í–‰ (ìƒ‰ìƒ ì—†ì´ ì¶œë ¥)

      # í…Œë¼í¼ ê³„íš ìƒì„± - ë³€ê²½ ì˜ˆì • ì‚¬í•­ ë¯¸ë¦¬ë³´ê¸°
      # PRì¼ ë•Œë§Œ ê³„íš ì‹¤í–‰ (CI ë‹¨ê³„)
      - name: í…Œë¼í¼ ê³„íš
        id: plan
        if: github.event_name == 'pull_request'   # PR ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
        run: terraform plan -no-color              # ë³€ê²½ ì‚¬í•­ ê³„íš ìƒì„±
        continue-on-error: true                    # ê³„íš ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰

      # PRì— ê³„íš ê²°ê³¼ ëŒ“ê¸€ ë‹¬ê¸° - ë¦¬ë·°ì–´ê°€ ë³€ê²½ ì‚¬í•­ í™•ì¸ ê°€ëŠ¥
      - name: PRì— ê³„íš ê²°ê³¼ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v6             # GitHub API ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì•¡ì…˜
        if: github.event_name == 'pull_request'    # PR ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"   # ê³„íš ì¶œë ¥ ê²°ê³¼ ì €ì¥
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}   # GitHub API í† í°
          script: |
            const output = `#### í…Œë¼í¼ ì´ˆê¸°í™” âš™ï¸\`${{ steps.init.outcome }}\`
            #### í…Œë¼í¼ í¬ë§· í™•ì¸ ğŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### í…Œë¼í¼ ìœ íš¨ì„± ê²€ì‚¬ ğŸ”\`${{ steps.validate.outcome }}\`
            #### í…Œë¼í¼ ê³„íš ğŸ“–\`${{ steps.plan.outcome }}\`

            <details><summary>ê³„íš ê²°ê³¼ ë³´ê¸°</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *PRì´ ìŠ¹ì¸ë˜ê³  main ë¸Œëœì¹˜ì— ë³‘í•©ë˜ë©´ ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ì´ ì ìš©ë©ë‹ˆë‹¤.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      # ----- CD ë‹¨ê³„ ì‹œì‘ (ë³€ê²½ ì‚¬í•­ ì ìš©) -----
      
      # main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ë³€ê²½ì‚¬í•­ ì ìš© (ì‹¤ì œ ì¸í”„ë¼ ë³€ê²½)
      - name: í…Œë¼í¼ ì ìš©
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'   # main ë¸Œëœì¹˜ í‘¸ì‹œ ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰
        run: terraform apply -auto-approve   # ìë™ ìŠ¹ì¸ìœ¼ë¡œ ë³€ê²½ ì‚¬í•­ ì ìš© (ì‹¤ì œ AWS ë¦¬ì†ŒìŠ¤ ìƒì„±/ìˆ˜ì •/ì‚­ì œ)
        # ì£¼ì˜: ì´ ë‹¨ê³„ì—ì„œ ì‹¤ì œ ì¸í”„ë¼ê°€ ë³€ê²½ë©ë‹ˆë‹¤!